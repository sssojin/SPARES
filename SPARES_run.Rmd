---
title: "SPARES_run"
output: html_document
---

## SPARES_Imputation

### Input
### - X : covariates matrix
### - y : survival times vector
### - censor_info : censoring vector
### - factor_var: vector of factor variables among independent variables
### - dist : distribution for imputation of censored survival times (weibull or lognormal)
### - reg_model : regression model for prediction of survival times (linear regression or random forests)
### - EoR_time : time of end of research
### - K : k value in KNN

### Output
### - y_hat : predicted survival times
### - imputed_y : imputed survival times for censored observation
### - model : fitted regression model
### - dat : new data with imputed_y

## SPARES_ASP

### Input
### - dat : output from the SPARES_Imputation
### - EoR_time : time of end of research

### Output
### - surv_time : survival probability matrix for each observation
### - asp : asp for the model


```{r}
rm(list=ls())
# Call Functions
source('MainFunctions.R')
source('SubFunctions.R')
source('BCRF.R')
source('Module.R')
```

## read file
```{r}
# Input data
data = read.csv('ExampleData.csv')
factor_var = c("g171school", "g171province", "g171sex",
              "g171f010", "g171f101", "g171f124",
              "g171g002", "X5", "X35")
y = data$eventtime
censor_info=data$status
X = subset(data, select = -c(eventtime, status))

# Variable name
discr_names=factor_var

# model options
EoR_time = 38
K = 10
dist = 'weibull' # you can choose among NORMAL, WEIBULL, LOGNORMAL
reg_model='lin' # you can choose among rf, lin, xgb
EoR_seed=1886

```



## Module1: SPARES_Imputation
```{r}
Imputation = SPARES_Imputation(X, y, censor_info, dist, reg_model, EoR_time, K,
                               y_var = 'eventtime', status_var = 'status', discr_names=factor_var)

model = Imputation$model
y_hat = Imputation$y_hat
dat = Imputation$dat
imputed_y = Imputation$imputed_y
```

## Module2: SPARES_ASP
```{r}
ASP = SPARES_ASP(dat, y_var='eventtime', status_var='status', discr_names=factor_var, EoR_time)

surv_time = ASP$Surv_time
asp_res = ASP$opt_ASP
asp = ASP$ASP
opt_sd = ASP$Opt_sd
asp_res; asp;opt_sd
```

